<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Equilibrium Grid</title>

<style>
:root {
--cell-size: clamp(72px, 22vmin, 120px);
--gap: clamp(8px, 3vmin, 16px);
--font-size: clamp(36px, 10vmin, 56px);
}

* {
box-sizing: border-box;
}

body {
margin: 0;
background: #0e0e0e;
color: #eee;
font-family: system-ui, sans-serif;
min-height: 100vh;
display: flex;
justify-content: center;
align-items: center;
}

.app {
display: flex;
flex-direction: column;
align-items: center;
gap: 16px;
}

h1 {
font-weight: 300;
margin: 0;
opacity: 0.9;
}

#stats {
display: flex;
gap: 2em;
font-size: 1.2em;
font-weight: 400;
}

#meter {
width: min(300px, 80vw);
height: 12px;
background: #1a1a1a;
border-radius: 6px;
overflow: hidden;
}

#progress {
height: 100%;
background: linear-gradient(to right, #ff4444, #ffaa00, #44ff44);
transition: width 0.3s ease;
width: 0%;
}

.grid {
display: grid;
grid-template-columns: repeat(3, var(--cell-size));
gap: var(--gap);
transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.cell {
width: var(--cell-size);
height: var(--cell-size);
background: #1e1e1e;
border-radius: 20%;
display: flex;
align-items: center;
justify-content: center;
font-size: var(--font-size);
user-select: none;
cursor: pointer;
touch-action: manipulation;
transition: all 0.15s ease;
}

@media (hover: hover) {
.cell:hover {
background: #2a2a2a;
}
}

.cell:active {
background: #333;
}

.buttons {
display: flex;
gap: 12px;
flex-wrap: wrap;
justify-content: center;
}

button {
background: #222;
color: #eee;
border: 1px solid #444;
padding: 12px 20px;
border-radius: 10px;
font-size: 16px;
cursor: pointer;
transition: background 0.15s;
}

button:active {
background: #333;
}
</style>
</head>

<body>
<div class="app">
<h1>–†–∞–≤–Ω–æ–≤–µ—Å–∏–µ</h1>
<div id="stats">
–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span> | –•–æ–¥—ã: <span id="moves">0</span>
</div>
<div id="meter"><div id="progress"></div></div>
<div class="grid" id="grid"></div>
<div class="buttons">
<button onclick="undo()">‚Ü∂ Undo</button>
<button onclick="hint()">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</button>
<button onclick="newLevel()">üîÑ –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å</button>
</div>
</div>

<script>
const SIZE = 3;
const TYPES = ["‚ö™", "‚¨ú", "üî∫"];
let grid = [];
let currentLevel = 0;
let moves = 0;
let history = [];

function neighbors(i) {
const x = i % SIZE;
const y = Math.floor(i / SIZE);
const t = grid[i];
let dirs = [];
if (t === 0) dirs = [[1,0],[-1,0],[0,1],[0,-1]];
if (t === 1) dirs = [[1,0],[-1,0]];
if (t === 2) dirs = [[0,1],[0,-1]];
return dirs
.map(([dx,dy]) => [x+dx, y+dy])
.filter(([nx,ny]) => nx>=0 && ny>=0 && nx<SIZE && ny<SIZE)
.map(([nx,ny]) => ny*SIZE + nx);
}

function applyMove(i) {
neighbors(i).forEach(n => {
grid[n] = (grid[n] + 1) % 3;
});
}

function isSolved() {
return grid.every(v => v === 0);
}

function animateRipple(neigh) {
neigh.forEach((n, idx) => {
setTimeout(() => {
const cell = document.querySelector(`[data-idx="${n}"]`);
if (cell) {
cell.style.transform = 'scale(1.3)';
setTimeout(() => {
cell.style.transform = '';
}, 150);
}
}, idx * 30);
});
}

function playSound(freq = 440, dur = 0.1) {
try {
const ctx = new (window.AudioContext || window.webkitAudioContext)();
const osc = ctx.createOscillator();
osc.type = 'sine';
osc.frequency.value = freq;
osc.connect(ctx.destination);
osc.start();
setTimeout(() => osc.stop(), dur * 1000);
} catch (e) {}
}

function clickCell(i) {
history.push(grid.slice());
if (history.length > 50) history.shift();
const neigh = neighbors(i);
animateRipple(neigh);
applyMove(i);
moves++;
playSound(600, 0.05);
render();
if (isSolved()) {
playSound(800, 0.2);
playSound(1000, 0.2);
setTimeout(() => {
alert(`‚úÖ –†–∞–≤–Ω–æ–≤–µ—Å–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ ${currentLevel} –∑–∞ ${moves} —Ö–æ–¥–æ–≤! üßò`);
}, 100);
}
}

function getImbalance() {
return grid.filter(v => v !== 0).length;
}

function updateMeter() {
const imb = getImbalance();
document.getElementById('progress').style.width = Math.max(0, (9 - imb) / 9 * 100) + '%';
}

function updateTilt() {
let torque = 0;
for (let i = 0; i < 9; i++) {
const col = i % 3;
torque += grid[i] * (col - 1);
}
const deg = torque * -1.5;
document.getElementById('grid').style.transform = `rotate(${deg}deg)`;
}

function updateStats() {
document.getElementById('level').textContent = currentLevel;
document.getElementById('moves').textContent = moves;
}

function render() {
const g = document.getElementById("grid");
g.innerHTML = "";
grid.forEach((v, i) => {
const d = document.createElement("div");
d.className = "cell";
d.textContent = TYPES[v];
d.dataset.idx = i;
d.onclick = () => clickCell(i);
g.appendChild(d);
});
updateMeter();
updateTilt();
updateStats();
}

function newLevel() {
currentLevel++;
grid = Array(SIZE * SIZE).fill(0);
const scrambles = Math.min(15, 2 + currentLevel);
for (let k = 0; k < scrambles; k++) {
applyMove(Math.floor(Math.random() * grid.length));
}
history = [];
moves = 0;
render();
}

function undo() {
if (history.length) {
grid = history.pop();
moves--;
render();
playSound(400, 0.08);
}
}

function getNextMove() {
const start = grid.slice();
const queue = [{ state: start.slice(), path: [], depth: 0 }];
const visited = new Set();
visited.add(start.join('|'));
while (queue.length) {
const { state, path, depth } = queue.shift();
if (state.every(v => v === 0)) {
return path[0];
}
if (depth > 12) continue;
for (let i = 0; i < 9; i++) {
const x = i % 3;
const y = Math.floor(i / 3);
const t = state[i];
let dirs = [];
if (t === 0) dirs = [[1,0],[-1,0],[0,1],[0,-1]];
else if (t === 1) dirs = [[1,0],[-1,0]];
else if (t === 2) dirs = [[0,1],[0,-1]];
const neigh = dirs
.map(([dx, dy]) => {
const nx = x + dx, ny = y + dy;
if (nx >= 0 && nx < 3 && ny >= 0 && ny < 3) return ny * 3 + nx;
return -1;
})
.filter(n => n >= 0);
const newState = state.slice();
neigh.forEach(n => newState[n] = (newState[n] + 1) % 3);
const key = newState.join('|');
if (!visited.has(key)) {
visited.add(key);
queue.push({ state: newState, path: [...path, i], depth: depth + 1 });
}
}
}
return -1;
}

function hint() {
const next = getNextMove();
if (next >= 0) {
const cell = document.querySelector(`[data-idx="${next}"]`);
if (cell) {
cell.style.boxShadow = '0 0 30px #44ff44';
cell.style.transition = 'box-shadow 0.3s';
playSound(700, 0.15);
setTimeout(() => {
cell.style.boxShadow = '';
}, 2000);
}
} else {
playSound(300, 0.1);
}
}

newLevel();
</script>
</body>
</html>
