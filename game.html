<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plague and Plenty</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">
  <style>
    body {
      background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
      background-color: #f4e4bc;
      color: #2c1b0e;
      font-family: 'Georgia', serif;
    }
    h1, h2 {
      font-family: 'Uncial Antiqua', cursive;
    }
    .parchment {
      background-color: #fff8e1;
      border: 2px solid #8b5a2b;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    .button:hover {
      filter: brightness(1.2);
    }
    .critical {
      color: #b91c1c;
      font-weight: bold;
      animation: pulse 1s infinite;
    }
    .peril {
      color: #b91c1c;
      font-weight: bold;
      animation: flash 0.5s infinite;
    }
    .warning {
      color: #b45309;
      font-style: italic;
    }
    .tooltip, .preview-tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext, .preview-tooltip .preview-text {
      visibility: hidden;
      width: 200px;
      background-color: #8b5a2b;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext, .preview-tooltip:hover .preview-text {
      visibility: visible;
      opacity: 1;
    }
    #round-progress {
      transition: width 0.5s ease-in-out;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff8e1;
      margin: 15% auto;
      padding: 20px;
      border: 2px solid #8b5a2b;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      text-align: center;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes flash {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div class="container max-w-3xl mx-auto p-6 parchment rounded-lg">
    <div id="start-screen" class="text-center">
      <h1 class="text-4xl mb-6 font-bold text-brown-800">Plague and Plenty</h1>
      <p class="text-lg mb-4">Choose thy path:</p>
      <select id="mode-select" class="p-2 bg-brown-100 rounded-lg mb-4">
        <option value="classic">Classic</option>
        <option value="campaign">Campaign</option>
      </select>
      <p class="text-lg mb-4">Choose thy challenge:</p>
      <select id="difficulty-select" class="p-2 bg-brown-100 rounded-lg mb-4">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
      </select>
      <br>
      <button id="begin-btn" class="button bg-green-600 text-white p-3 rounded-lg font-semibold">Begin</button>
      <button id="tutorial-btn" class="button bg-blue-600 text-white p-3 rounded-lg font-semibold ml-2">How to Play</button>
      <button id="milestones-btn" class="button bg-purple-600 text-white p-3 rounded-lg font-semibold ml-2">View Milestones</button>
      <button id="endings-btn" class="button bg-red-600 text-white p-3 rounded-lg font-semibold ml-2">View Endings</button>
    </div>
    <div id="game-screen" class="hidden">
      <h1 class="text-4xl text-center mb-6 font-bold text-brown-800">Plague and Plenty</h1>
      <div class="mb-4">
        <div id="game-status" class="text-center text-xl mb-2"></div>
        <div class="w-full bg-gray-300 rounded-full h-4">
          <div id="round-progress" class="bg-green-600 h-4 rounded-full" style="width: 10%"></div>
        </div>
      </div>
      <div id="village" class="p-6 bg-brown-100 rounded-lg mb-4 text-center"></div>
      <div id="warnings" class="text-center mb-4"></div>
      <div id="actions" class="text-center mb-4 flex justify-center gap-4 flex-wrap"></div>
      <div id="event-log" class="p-4 bg-brown-50 rounded-lg max-h-48 overflow-y-auto"></div>
    </div>
    <div id="trade-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4">Trade Offer</h2>
        <p class="mb-4">Choose thy trade:</p>
        <button onclick="performTrade('pop')" class="button bg-yellow-600 text-white p-2 rounded-lg mb-2">10 Population → 50 Food</button>
        <button onclick="performTrade('food')" class="button bg-yellow-600 text-white p-2 rounded-lg mb-2">50 Food → 10 Population</button>
        <button onclick="closeModal('trade-modal')" class="button bg-gray-600 text-white p-2 rounded-lg">Cancel</button>
      </div>
    </div>
    <div id="upgrade-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4">Upgrade Village</h2>
        <p class="mb-4">Choose thy upgrade:</p>
        <button onclick="performUpgrade('granary')" class="button bg-orange-600 text-white p-2 rounded-lg mb-2" id="granary-btn">Granary (50 Food or Wealth, 5 Pop or none)</button>
        <button onclick="performUpgrade('infirmary')" class="button bg-orange-600 text-white p-2 rounded-lg mb-2" id="infirmary-btn">Infirmary (30 Food or Wealth, 5 Pop or none)</button>
        <button onclick="performUpgrade('walls')" class="button bg-orange-600 text-white p-2 rounded-lg mb-2" id="walls-btn">Walls (40 Food or Wealth, 10 Pop or none)</button>
        <button onclick="closeModal('upgrade-modal')" class="button bg-gray-600 text-white p-2 rounded-lg">Cancel</button>
      </div>
    </div>
    <div id="appease-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4">Appease Faction</h2>
        <p class="mb-4">Choose whom to appease:</p>
        <button onclick="performAppease('peasants')" class="button bg-green-600 text-white p-2 rounded-lg mb-2">Peasants (15 Food)</button>
        <button onclick="performAppease('clergy')" class="button bg-blue-600 text-white p-2 rounded-lg mb-2">Clergy (15 Food)</button>
        <button onclick="performAppease('warriors')" class="button bg-red-600 text-white p-2 rounded-lg mb-2">Warriors (15 Food)</button>
        <button onclick="closeModal('appease-modal')" class="button bg-gray-600 text-white p-2 rounded-lg">Cancel</button>
      </div>
    </div>
    <div id="event-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4" id="event-title"></h2>
        <p class="mb-4" id="event-description"></p>
        <button id="event-choice-1" class="button bg-blue-600 text-white p-2 rounded-lg mb-2"></button>
        <button id="event-choice-2" class="button bg-blue-600 text-white p-2 rounded-lg mb-2"></button>
      </div>
    </div>
    <div id="tutorial-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4">How to Play</h2>
        <p class="mb-4">Guide thy village through 10 years of plague and plenty. Each action advances the year, consuming Food and triggering events. Manage Population, Food, Health, Wealth, and Morale to survive:</p>
        <ul class="text-left mb-4">
          <li><b>Till the Fields</b>: Gain ~40 Food, boosted in Spring. Prevents famine.</li>
          <li><b>Tend the Sick</b>: Gain ~15 Health, boosted in Winter. Keeps pestilence at bay.</li>
          <li><b>Call Newcomers</b>: Gain ~12 Population, weaker in Spring. Replenishes thy village.</li>
          <li><b>Fortify Village</b>: Spend 20 Food to halve damage, lasts longer with Walls. Shields against events.</li>
          <li><b>Trade</b>: Swap 10 Population/Food once. Balances resources.</li>
          <li><b>Hold Festival</b>: Spend 30 Food for 15 Population if Health > 80. Boosts growth.</li>
          <li><b>Upgrade Village</b>: Build Granary (more Food), Infirmary (more Health), or Walls (stronger defenses).</li>
          <li><b>Tax Villagers</b>: Gain ~20 Wealth, angers Peasants. Funds mercenaries or upgrades.</li>
          <li><b>Appease Faction</b>: Spend 15 Food to boost Morale. Prevents revolts.</li>
          <li><b>Hire Mercenaries</b>: Spend 30 Wealth for 15 Population. Bolsters numbers.</li>
          <li><b>Double Down</b>: Spend 5 Wealth to double action gains, 10% failure risk. Amplifies efforts.</li>
        </ul>
        <p class="mb-4"><b>Survival Tips</b>: Keep Population > 15 and Food > 30 to avoid famine. Maintain Morale > 30 to prevent revolts. In Campaign, aim for Population > 80 and Health > 70. Check “Next Turn Preview” for risks!</p>
        <p class="mb-4">Seasons shift strategies: Farm in Spring, Fortify in Winter. Events and relics test thy wits—choose wisely! Campaign weaves a tale with Loyalist, Rebel, or Mystic paths; Classic seeks high Legacy Scores.</p>
        <button onclick="closeModal('tutorial-modal')" class="button bg-gray-600 text-white p-2 rounded-lg">Close</button>
      </div>
    </div>
    <div id="milestones-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4">Milestones</h2>
        <ul id="milestones-list" class="text-left mb-4"></ul>
        <button onclick="closeModal('milestones-modal')" class="button bg-gray-600 text-white p-2 rounded-lg">Close</button>
      </div>
    </div>
    <div id="endings-modal" class="modal">
      <div class="modal-content">
        <h2 class="text-2xl mb-4">Campaign Endings</h2>
        <ul id="endings-list" class="text-left mb-4"></ul>
        <button onclick="closeModal('endings-modal')" class="button bg-gray-600 text-white p-2 rounded-lg">Close</button>
      </div>
    </div>
  </div>

  <script>
    let difficulty = 'normal';
    let mode = 'classic';
    let season = 'spring';
    let fortifiedRounds = 0;
    let gameState = {
      eventChains: {
        banditSaga: { active: false, stage: 0 },
        relicCurse: { active: false, stage: 0 },
        royalIntrigue: { active: false, stage: 0 }
      },
      campaignProgress: { loyal: false, rebel: false, mystic: false, faminePrepared: false, curseLifted: false, ending: null }
    };
    const village = {
      name: "Thy Village",
      population: 60,
      food: 100,
      health: 30,
      wealth: 0,
      morale: { peasants: 60, clergy: 60, warriors: 60 },
      upgrades: { granary: false, infirmary: false, walls: false },
      relics: { plenty: false, vitality: false, valor: false }
    };
    const seasons = [
      { round: 1, name: 'Spring' }, { round: 2, name: 'Summer' }, { round: 3, name: 'Autumn' }, { round: 4, name: 'Winter' },
      { round: 5, name: 'Spring' }, { round: 6, name: 'Summer' }, { round: 7, name: 'Autumn' }, { round: 8, name: 'Winter' },
      { round: 9, name: 'Spring' }, { round: 10, name: 'Summer' }
    ];
    const randomEvents = [
      { name: "Plague Scours the Land", effect: () => {
          const damage = Math.min(15, Math.floor(25 * (100 - village.health) / 100 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1)));
          village.population = Math.max(0, village.population - Math.floor(damage * (fortifiedRounds > 0 || village.relics.valor ? 0.5 : 1)));
        }, color: "text-red-600", weight: season === 'winter' ? 0.3 : 0.1 },
      { name: "Meager Harvest", effect: () => {
          village.food += Math.floor(30 * (difficulty === 'easy' ? 1.2 : difficulty === 'hard' ? 0.8 : 1) * (village.upgrades.granary ? 1.2 : 1) * (village.relics.plenty ? 1.1 : 1));
        }, color: "text-green-600", weight: season === 'autumn' ? 0.3 : 0.1 },
      { name: "Healer Passes By", effect: () => {
          village.health = Math.min(100, village.health + Math.floor(15 * (difficulty === 'easy' ? 1.2 : difficulty === 'hard' ? 0.8 : 1) * (village.upgrades.infirmary ? 1.2 : 1) * (village.relics.vitality ? 1.1 : 1)));
        }, color: "text-blue-600", weight: 0.1 },
      { name: "Bitter Winter", effect: () => {
          village.food -= Math.min(30, 40 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1));
          village.health -= Math.min(15, 20 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1));
          village.population -= Math.min(5, 5 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1));
        }, color: "text-red-600", weight: season === 'winter' ? 0.3 : 0.05 },
      { name: "Refugees Beg Entry", effect: () => {
          village.population += 25 * (village.relics.valor ? 0.9 : 1);
          village.food -= 30 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1);
          village.health -= 10 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1);
        }, color: "text-purple-600", weight: 0.1 },
      { name: "Spring Flood", effect: () => {
          village.food -= 20 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1);
        }, color: "text-red-600", weight: season === 'spring' ? 0.2 : 0.05 },
      { name: "Summer Fair", effect: () => {
          village.population += 10 * (village.relics.valor ? 0.9 : 1);
          village.food -= 15 * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1);
        }, color: "text-green-600", weight: season === 'summer' ? 0.2 : 0.05 },
      { name: "Catastrophe", effect: () => {
          village.food = Math.floor(village.food / 2);
          village.population = Math.floor(village.population / 2);
        }, color: "text-red-600", weight: difficulty === 'hard' ? 0.05 : 0 },
      { name: "Relic’s Curse", effect: () => {
          village.food -= 10;
          village.health -= 10;
          village.population -= 5;
        }, color: "text-red-600", weight: Object.values(village.relics).some(r => r) ? 0.1 : 0 },
      { name: "Merchant’s Gift", effect: () => {
          village.wealth += 20;
        }, color: "text-purple-600", weight: 0.05 }
    ];
    const choiceEvents = [
      { name: "Merchant Caravan", description: "A caravan offers trade. Accept?", choice1: { text: "Accept", effect: () => { village.wealth += 30; village.population -= 10; } }, choice2: { text: "Reject", effect: () => {} }, color: "text-purple-600" },
      { name: "Witch Accusation", description: "Villagers accuse a healer of witchcraft. Banish her?", choice1: { text: "Banish", effect: () => { village.health += 10; window.nextRoundPlagueChance = 0.2; village.morale.clergy -= 10; } }, choice2: { text: "Protect", effect: () => { village.population -= 10; village.morale.clergy += 10; gameState.campaignProgress.mystic = true; } }, color: "text-red-600" },
      { name: "Stranded Pilgrims", description: "Pilgrims seek shelter. Welcome them?", choice1: { text: "Welcome", effect: () => { village.population += 15; village.food -= 20; village.health -= 5; village.morale.clergy += 5; } }, choice2: { text: "Turn Away", effect: () => { village.health -= 10; village.morale.clergy -= 10; } }, color: "text-purple-600" },
      { name: "Relic of Plenty", description: "A relic promising bounty is found. Keep it?", choice1: { text: "Keep", effect: () => { village.relics.plenty = true; gameState.eventChains.relicCurse = { active: true, stage: 1 }; } }, choice2: { text: "Destroy", effect: () => { village.morale.clergy += 10; } }, color: "text-blue-600" },
      { name: "Relic of Vitality", description: "A relic of life is found. Keep it?", choice1: { text: "Keep", effect: () => { village.relics.vitality = true; village.morale.warriors -= 10; gameState.eventChains.relicCurse = { active: true, stage: 1 }; } }, choice2: { text: "Destroy", effect: () => { village.morale.clergy += 10; } }, color: "text-blue-600" },
      { name: "Relic of Valor", description: "A relic of courage is found. Keep it?", choice1: { text: "Keep", effect: () => { village.relics.valor = true; gameState.eventChains.relicCurse = { active: true, stage: 1 }; } }, choice2: { text: "Destroy", effect: () => { village.morale.clergy += 10; } }, color: "text-blue-600" }
    ];
    const chainEvents = [
      { name: "Bandit Saga: Hunt or Pay", description: "Bandits demand tribute. Respond?", choice1: { text: "Hunt", effect: () => { village.population -= 10; gameState.eventChains.banditSaga.active = false; village.morale.warriors += 10; } }, choice2: { text: "Pay", effect: () => { village.wealth -= 20; gameState.eventChains.banditSaga.stage = 2; } }, color: "text-red-600" },
      { name: "Bandit Saga: Alliance", description: "Bandits offer alliance. Accept?", choice1: { text: "Accept", effect: () => { village.population += 15; village.morale.peasants -= 20; village.morale.clergy -= 20; village.morale.warriors -= 20; gameState.eventChains.banditSaga.active = false; } }, choice2: { text: "Reject", effect: () => { village.food -= 30; gameState.eventChains.banditSaga.active = false; } }, color: "text-red-600" },
      { name: "Relic Curse: Spreads", description: "The relic’s curse grows. Purify it?", choice1: { text: "Purify", effect: () => { village.wealth -= 30; Object.keys(village.relics).forEach(r => village.relics[r] = false); gameState.eventChains.relicCurse.active = false; gameState.campaignProgress.curseLifted = true; } }, choice2: { text: "Ignore", effect: () => { village.health -= 15; gameState.eventChains.relicCurse.active = false; } }, color: "text-red-600" },
      { name: "Royal Intrigue: Spy Uncovered", description: "A spy is found. Expose them?", choice1: { text: "Expose", effect: () => { village.wealth += 10; gameState.eventChains.royalIntrigue.active = false; } }, choice2: { text: "Ignore", effect: () => { village.food -= 20; gameState.eventChains.royalIntrigue.active = false; } }, color: "text-red-600" }
    ];
    const campaignEvents = [
      { round: 1, name: "Curse Revealed", description: "A relic curses thy village. Seek aid?", choice1: { text: "Seek Aid", effect: () => { village.health -= 10; gameState.campaignProgress.mystic = true; } }, choice2: { text: "Endure", effect: () => { village.population -= 5; } }, color: "text-red-600" },
      { round: 2, name: "Hermit’s Warning", description: "A hermit warns of famine. Stockpile?", choice1: { text: "Stockpile", effect: () => { village.food -= 20; gameState.campaignProgress.faminePrepared = true; } }, choice2: { text: "Ignore", effect: () => {} }, color: "text-purple-600" },
      { round: 3, name: "Royal Envoy", description: "The King demands loyalty. Pledge?", choice1: { text: "Pledge", effect: () => { gameState.campaignProgress.loyal = true; village.morale.peasants -= 10; village.morale.warriors += 10; village.wealth += 50; } }, choice2: { text: "Rebel", effect: () => { village.food -= 30; gameState.campaignProgress.rebel = true; village.morale.warriors += 10; gameState.eventChains.royalIntrigue = { active: true, stage: 1 }; } }, color: "text-red-600" },
      { round: 4, name: "Dark Winter", description: "Winter bites. Share food?", choice1: { text: "Share", effect: () => { village.food -= 20; village.population += 10; village.morale.peasants += 10; } }, choice2: { text: "Hoard", effect: () => { village.health -= 10; village.morale.peasants -= 10; } }, color: "text-red-600" },
      { round: 5, name: "Healer’s Aid", description: "A healer offers help if aided. Accept?", choice1: { text: "Accept", effect: () => { village.food -= 15; village.health += 20; village.morale.clergy += 10; } }, choice2: { text: "Refuse", effect: () => { village.morale.clergy -= 10; } }, color: "text-blue-600" },
      { round: 6, name: "Bandit Threat", description: "Bandits near. Pay tribute?", choice1: { text: "Pay", effect: () => { village.wealth -= 30; } }, choice2: { text: "Fight", effect: () => { village.population -= 10; village.morale.warriors += 10; gameState.eventChains.banditSaga = { active: true, stage: 1 }; } }, color: "text-red-600" },
      { round: 7, name: "Refugee Plight", description: "Refugees beg entry. Accept?", choice1: { text: "Accept", effect: () => { village.population += 20; village.food -= 25; village.morale.peasants += 5; } }, choice2: { text: "Reject", effect: () => { village.health -= 5; village.morale.peasants -= 10; } }, color: "text-purple-600" },
      { round: 8, name: "Curse Resurges", description: "The curse returns. Pray?", choice1: { text: "Pray", effect: () => { village.health += 10; village.morale.clergy += 10; gameState.campaignProgress.curseLifted = true; } }, choice2: { text: "Defy", effect: () => { village.population -= 10; village.morale.clergy -= 10; } }, color: "text-red-600" },
      { round: 9, name: "Final Stand", description: "The King tests thee. Submit?", choice1: { text: "Submit", effect: () => { village.wealth -= 20; village.morale.peasants -= 10; } }, choice2: { text: "Resist", effect: () => { village.population -= 15; village.morale.warriors += 10; } }, color: "text-red-600" },
      { round: 10, name: "Curse Climax", description: gameState.campaignProgress.loyal ? "The King audits thy loyalty. Pay tribute?" : gameState.campaignProgress.rebel ? "A royal siege threatens. Fight?" : "The curse peaks. Sacrifice relic?", choice1: { text: gameState.campaignProgress.loyal ? "Pay" : gameState.campaignProgress.rebel ? "Fight" : "Sacrifice", effect: () => { 
          if (gameState.campaignProgress.loyal) village.wealth -= 50;
          else if (gameState.campaignProgress.rebel) village.population -= 20;
          else { Object.keys(village.relics).forEach(r => village.relics[r] = false); village.population -= 10; }
          gameState.campaignProgress.curseLifted = true;
        } }, choice2: { text: gameState.campaignProgress.loyal ? "Defy" : gameState.campaignProgress.rebel ? "Surrender" : "Preserve", effect: () => {
          if (gameState.campaignProgress.loyal) village.food -= 50;
          else if (gameState.campaignProgress.rebel) village.food -= 50;
        } }, color: "text-blue-600" }
    ];
    let round = 1;
    const maxRounds = 10;
    const eventLog = [];
    let tradeUsed = false;
    let legacyScore = 0;
    let highScore = localStorage.getItem('plagueHighScore') || 0;
    const milestones = [
      { name: "Survivor", score: 200, achieved: false },
      { name: "Steward", score: 350, achieved: false },
      { name: "Hero", score: 500, achieved: false },
      { name: "Legend", score: 750, achieved: false }
    ];
    const endings = [
      { name: "True Victory", description: "Curse lifted, village thrives.", achieved: false },
      { name: "Rebel Triumph", description: "Defeated siege, curse lingers.", achieved: false },
      { name: "Cursed Survival", description: "Survived, curse persists.", achieved: false },
      { name: "Doomed Village", description: "Village falls.", achieved: false }
    ];
    let doubleDownAction = null;

    function getTurnPreview() {
      const consumptionRate = (difficulty === 'easy' ? 1.0 : difficulty === 'hard' ? 1.6 : 1.3) * (season === 'summer' ? 1.1 : 1) * (village.relics.plenty ? 1.1 : 1);
      const foodNeeded = Math.floor(village.population * consumptionRate);
      const healthThreshold = difficulty === 'easy' ? 60 : 50;
      let preview = [];
      preview.push(`<b>Food Needed</b>: ~${foodNeeded} bushels (Current: ${Math.floor(village.food)})`);
      if (village.food < foodNeeded) {
        const deaths = Math.floor((foodNeeded - village.food) / consumptionRate);
        preview.push(`<span class="text-red-600">Famine Risk: ~${deaths} may perish!</span>`);
      }
      if (village.health < healthThreshold) {
        const maxDeaths = difficulty === 'easy' ? 10 : difficulty === 'hard' ? 20 : 15;
        const deaths = Math.min(maxDeaths, Math.floor(15 * (healthThreshold - village.health) / healthThreshold * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1)));
        preview.push(`<span class="text-red-600">Pestilence Risk: ~${deaths} may fall!</span>`);
      }
      if ([6, 9].includes(round + 1) && !window.skipNextArmyDemand) {
        const armyDemand = Math.min(difficulty === 'easy' ? 50 : difficulty === 'hard' ? 70 : 60, Math.floor((difficulty === 'normal' ? 45 : difficulty === 'easy' ? 35 : 55) * (season === 'autumn' ? 1.2 : 1) * (gameState.campaignProgress.loyal ? 0.8 : 1)));
        preview.push(`<span class="text-red-600">King’s Demand: ~${armyDemand} Food!</span>`);
      }
      if (season === 'winter' || window.nextRoundPlagueChance > 0) {
        preview.push(`<span class="text-red-600">Plague Risk: High in ${season === 'winter' ? 'Winter' : 'next turn'}!</span>`);
      }
      if (Object.values(village.morale).some(m => m < 40)) {
        const factions = Object.keys(village.morale).filter(f => village.morale[f] < 40).map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ');
        preview.push(`<span class="text-red-600">${factions} unrest—appease them!</span>`);
      }
      return preview.join('<br>');
    }

    function startGame() {
      mode = document.getElementById('mode-select').value;
      difficulty = document.getElementById('difficulty-select').value;
      const resourceMultiplier = difficulty === 'easy' ? 1.25 : difficulty === 'hard' ? 0.8 : 1;
      village.population = Math.floor(60 * resourceMultiplier);
      village.food = Math.floor((difficulty === 'easy' ? 150 : 100) * resourceMultiplier);
      village.health = Math.floor(30 * resourceMultiplier);
      village.wealth = 0;
      village.morale = { peasants: 60, clergy: 60, warriors: 60 };
      village.upgrades = { granary: false, infirmary: false, walls: false };
      village.relics = { plenty: false, vitality: false, valor: false };
      tradeUsed = false;
      round = 1;
      eventLog.length = 0;
      fortifiedRounds = 0;
      legacyScore = 0;
      gameState = {
        eventChains: {
          banditSaga: { active: false, stage: 0 },
          relicCurse: { active: false, stage: 0 },
          royalIntrigue: { active: false, stage: 0 }
        },
        campaignProgress: { loyal: false, rebel: false, mystic: false, faminePrepared: false, curseLifted: false, ending: null }
      };
      window.nextRoundPlagueChance = 0;
      window.skipNextArmyDemand = false;
      window.nextArmyDemandDoubled = false;
      window.healerFatigue = false;
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('game-screen').classList.remove('hidden');
      initializeGame();
    }

    function resetGame() {
      document.getElementById('game-screen').classList.add('hidden');
      document.getElementById('start-screen').classList.remove('hidden');
      document.getElementById('event-log').innerHTML = '';
    }

    function initializeGame() {
      updateSeason();
      updateUI();
      startTurn();
    }

    function updateSeason() {
      if (round <= maxRounds) {
        season = seasons[round - 1].name.toLowerCase();
      }
    }

    function applyRandomEvent() {
      if (mode === 'campaign') {
        const event = campaignEvents[round - 1];
        showEventModal(event);
      } else {
        let selectedEvent = null;
        if (gameState.eventChains.banditSaga.active && gameState.eventChains.banditSaga.stage === 1 && round === 6) {
          selectedEvent = chainEvents.find(e => e.name === "Bandit Saga: Hunt or Pay");
        } else if (gameState.eventChains.banditSaga.active && gameState.eventChains.banditSaga.stage === 2 && round === 7) {
          selectedEvent = chainEvents.find(e => e.name === "Bandit Saga: Alliance");
        } else if (gameState.eventChains.relicCurse.active && gameState.eventChains.relicCurse.stage === 1 && round === 3) {
          selectedEvent = chainEvents.find(e => e.name === "Relic Curse: Spreads");
        } else if (gameState.eventChains.royalIntrigue.active && gameState.eventChains.royalIntrigue.stage === 1 && round === 5) {
          selectedEvent = chainEvents.find(e => e.name === "Royal Intrigue: Spy Uncovered");
        }
        if (!selectedEvent) {
          const relicEventChance = Math.random();
          if (relicEventChance < 0.2 && !Object.values(village.relics).some(r => r)) {
            const relicEvents = choiceEvents.filter(e => e.name.startsWith("Relic"));
            selectedEvent = relicEvents[Math.floor(Math.random() * relicEvents.length)];
          } else {
            const totalWeight = randomEvents.reduce((sum, e) => sum + e.weight, 0);
            let random = Math.random() * totalWeight;
            for (const event of randomEvents) {
              random -= event.weight;
              if (random <= 0) {
                selectedEvent = event;
                break;
              }
            }
            if (window.nextRoundPlagueChance > 0 && Math.random() < window.nextRoundPlagueChance) {
              selectedEvent = randomEvents.find(e => e.name === "Plague Scours the Land");
              window.nextRoundPlagueChance = 0;
            }
          }
        }
        if (choiceEvents.some(e => e.name === selectedEvent.name) || chainEvents.some(e => e.name === selectedEvent.name)) {
          showEventModal(selectedEvent);
        } else {
          if (selectedEvent.name === "Plague Scours the Land") {
            addToLog('<span class="text-red-600">Rumors of plague spread...</span>');
          }
          selectedEvent.effect();
          addToLog(`<span class="${selectedEvent.color}">${selectedEvent.name}!</span>`);
          if (fortifiedRounds > 0) fortifiedRounds--;
          checkFactionEvents();
        }
      }
    }

    function showEventModal(event) {
      document.getElementById('event-title').textContent = event.name;
      document.getElementById('event-description').textContent = event.description;
      const choice1Btn = document.getElementById('event-choice-1');
      const choice2Btn = document.getElementById('event-choice-2');
      choice1Btn.textContent = event.choice1.text;
      choice2Btn.textContent = event.choice2.text;
      choice1Btn.onclick = () => {
        event.choice1.effect();
        addToLog(`<span class="${event.color}">${event.name}: ${event.choice1.text}</span>`);
        closeModal('event-modal');
        if (fortifiedRounds > 0) fortifiedRounds--;
        checkFactionEvents();
      };
      choice2Btn.onclick = () => {
        event.choice2.effect();
        addToLog(`<span class="${event.color}">${event.name}: ${event.choice2.text}</span>`);
        closeModal('event-modal');
        if (fortifiedRounds > 0) fortifiedRounds--;
        checkFactionEvents();
      };
      document.getElementById('event-modal').style.display = 'block';
    }

    function checkFactionEvents() {
      if (village.morale.peasants < 30) {
        village.population -= 5;
        addToLog('<span class="text-red-600">Peasant Revolt: 5 flee!</span>');
        village.morale.peasants = Math.min(100, village.morale.peasants + 10);
      } else if (village.morale.peasants < 40) {
        addToLog('<span class="text-red-600">Peasants grumble—appease them soon!</span>');
      }
      if (village.morale.clergy < 30) {
        village.health = Math.max(0, Math.floor(village.health * 0.75));
        addToLog('<span class="text-red-600">Clergy Schism: Health reduced!</span>');
        village.morale.clergy = Math.min(100, village.morale.clergy + 10);
      } else if (village.morale.clergy < 40) {
        addToLog('<span class="text-red-600">Clergy waver—appease them soon!</span>');
      }
      if (village.morale.warriors < 30) {
        village.food -= 10;
        addToLog('<span class="text-red-600">Warrior Mutiny: 10 Food lost!</span>');
        village.morale.warriors = Math.min(100, village.morale.warriors + 10);
      } else if (village.morale.warriors < 40) {
        addToLog('<span class="text-red-600">Warriors unrest—appease them soon!</span>');
      }
    }

    function applyConsumptionAndArmy() {
      const consumptionRate = (difficulty === 'easy' ? 1.0 : difficulty === 'hard' ? 1.6 : 1.3) * (season === 'summer' ? 1.1 : 1) * (village.relics.plenty ? 1.1 : 1);
      const foodNeeded = village.population * consumptionRate;
      if (village.food < foodNeeded) {
        const deaths = Math.floor((foodNeeded - village.food) / consumptionRate);
        village.population = Math.max(0, village.population - deaths);
        addToLog(`<span class="text-red-red-600">Hunger slays ${deaths} villagers!</span>`);
        village.morale.peasants -= 10;
        village.morale.clergy -= 10;
        village.morale.warriors -= 10;
      }
      village.food = Math.max(0, village.food - foodNeeded);
      const healthThreshold = difficulty === 'easy' ? 60 : 50;
      if (village.health < healthThreshold) {
        const maxDeaths = difficulty === 'easy' ? 10 : difficulty === 'hard' ? 20 : 15;
        const deaths = Math.min(maxDeaths, Math.floor(15 * (healthThreshold - village.health) / healthThreshold * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1)));
        village.population = Math.max(0, village.population - deaths);
        addToLog(`<span class="text-red-600">Pestilence claims ${deaths} souls!</span>`);
        village.morale.clergy -= 10;
      }
      if ([6, 9].includes(round) && !window.skipNextArmyDemand) {
        let armyDemand = Math.min(difficulty === 'easy' ? 50 : difficulty === 'hard' ? 70 : 60, Math.floor((difficulty === 'normal' ? (30 + Math.random() * 30) : (20 + Math.random() * 50)) * (difficulty === 'easy' ? 0.7 : difficulty === 'hard' ? 1.3 : 1) * (season === 'autumn' ? 1.2 : 1)));
        if (window.nextArmyDemandDoubled) {
          armyDemand *= 2;
          window.nextArmyDemandDoubled = false;
        }
        if (gameState.campaignProgress.loyal) armyDemand *= 0.8;
        village.food = Math.max(0, village.food - armyDemand);
        addToLog(`<span class="text-red-600">The King seizes ${armyDemand} bushels!</span>`);
        village.morale.peasants -= 5;
        window.skipNextArmyDemand = false;
      }
    }

    function performAction(action, doubleDown = false) {
      const actionMultiplier = (difficulty === 'easy' ? 1.2 : difficulty === 'hard' ? 0.8 : 1) * 
        (season === 'spring' && action === 'farm' ? 1.2 : season === 'summer' && action === 'heal' ? 1.2 : season === 'spring' && action === 'recruit' ? 0.8 : 1) *
        (action === 'farm' && village.morale.peasants < 30 ? 0.8 : action === 'heal' && village.morale.clergy < 30 ? 0.8 : 1) *
        (doubleDown ? 2 : 1);
      const randomFactor = 0.9 + Math.random() * 0.2;
      let message = '';
      let proceed = true;

      if (doubleDown && village.wealth < 5) {
        message = `Not enough Wealth to Double Down!`;
        proceed = false;
      } else if (doubleDown && Math.random() < 0.1) {
        message = `Double Down fails—gains halved!`;
        actionMultiplier *= 0.5;
        village.morale.peasants -= 5;
        village.morale.clergy -= 5;
        village.morale.warriors -= 5;
        village.wealth -= 5;
      } else if (doubleDown) {
        village.wealth -= 5;
      }

      if (action === 'farm') {
        let foodGain = Math.floor(40 * randomFactor * actionMultiplier * (village.upgrades.granary ? 1.2 : 1) * (village.relics.plenty ? 1.1 : 1));
        if (season === 'autumn' && village.upgrades.granary && Math.random() < 0.1) {
          foodGain += 20;
          message = `Bumper Crop yields ${foodGain} bushels!`;
        } else if (village.morale.peasants < 30 && Math.random() < 0.2) {
          foodGain -= 10;
          message = `Crop Failure yields only ${foodGain} bushels!`;
        } else {
          message = `Thy fields yield ${foodGain} bushels!`;
        }
        village.food += foodGain;
        village.morale.peasants += 10;
      } else if (action === 'heal') {
        let healthGain = Math.floor(15 * randomFactor * actionMultiplier * (village.upgrades.infirmary ? 1.2 : 1) * (village.relics.vitality ? 1.1 : 1));
        if (village.health < 30 && Math.random() < 0.2) {
          window.healerFatigue = true;
          healthGain = 0;
          message = `Healer Fatigue—no Health gained!`;
        } else if (season === 'winter' && village.morale.clergy > 70) {
          healthGain += 5;
          message = `Clergy’s faith restores ${healthGain} vigor!`;
        } else {
          message = `Leeches restore ${healthGain} vigor!`;
        }
        village.health = Math.min(100, village.health + healthGain);
        village.morale.clergy += 10;
        if (window.healerFatigue && healthGain > 0) window.healerFatigue = false;
      } else if (action === 'recruit') {
        let popGain = Math.floor(12 * randomFactor * actionMultiplier * (village.relics.valor ? 0.9 : 1));
        if (season === 'summer' && village.morale.peasants > 70) {
          popGain += 5;
          message = `Peasants draw ${popGain} souls!`;
        } else if (village.morale.peasants < 30 && Math.random() < 0.2) {
          popGain -= 5;
          message = `Desertion limits gain to ${popGain} souls!`;
        } else {
          message = `${popGain} weary souls join thy fold!`;
        }
        village.population += popGain;
      } else if (action === 'fortify') {
        const fortifyCost = 20 * (season === 'winter' ? 0.8 : season === 'spring' ? 1.1 : 1);
        if (village.food >= fortifyCost) {
          village.food -= fortifyCost;
          fortifiedRounds = village.upgrades.walls ? 2 : 1;
          message = `Thy village fortifies against calamity!`;
          if (village.upgrades.walls && Math.random() < 0.2) village.morale.warriors += 5;
          village.morale.warriors += 10;
        } else {
          message = `Not enough Food to fortify!`;
          proceed = false;
        }
      } else if (action === 'trade') {
        document.getElementById('trade-modal').style.display = 'block';
        return;
      } else if (action === 'festival') {
        if (village.health > 80 && village.food >= 30) {
          village.food -= 30;
          const popGain = Math.floor(15 * actionMultiplier);
          village.population += popGain;
          message = `A grand festival draws ${popGain} new souls!`;
          village.morale.peasants += 10;
        } else {
          message = `Need Health > 80 and 30 Food for a festival!`;
          proceed = false;
        }
      } else if (action === 'upgrade') {
        document.getElementById('granary-btn').disabled = village.upgrades.granary;
        document.getElementById('infirmary-btn').disabled = village.upgrades.infirmary;
        document.getElementById('walls-btn').disabled = village.upgrades.walls;
        document.getElementById('upgrade-modal').style.display = 'block';
        return;
      } else if (action === 'tax') {
        const wealthGain = Math.floor(15 + randomFactor * 10);
        village.wealth += wealthGain;
        message = `Taxes yield ${wealthGain} gold!`;
        village.morale.peasants -= 10;
      } else if (action === 'appease') {
        document.getElementById('appease-modal').style.display = 'block';
        return;
      } else if (action === 'mercenaries') {
        if (village.wealth >= 30) {
          village.wealth -= 30;
          village.population += 15;
          message = `Mercenaries bolster thy ranks by 15!`;
          village.morale.warriors += 10;
          village.morale.peasants -= 10;
        } else {
          message = `Not enough Wealth to hire mercenaries!`;
          proceed = false;
        }
      }

      if (village.health > 90 && Math.random() < 0.1) {
        fortifiedRounds = 1;
        addToLog(`<span class="text-green-600">Thy village’s vigor inspires free fortification!</span>`);
      }

      addToLog(`<span class="text-brown-800">${message}</span>`);
      if (proceed && !['trade', 'upgrade', 'appease'].includes(action)) {
        applyConsumptionAndArmy();
        applyRandomEvent();
        round++;
      }
      checkGameOver();
    }

    function performTrade(type) {
      let message = '';
      if (!tradeUsed) {
        if (type === 'pop' && village.population >= 10) {
          village.population -= 10;
          village.food += 50;
          message = `Traded 10 souls for 50 bushels!`;
          tradeUsed = true;
        } else if (type === 'food' && village.food >= 50) {
          village.food -= 50;
          village.population += 10;
          message = `Traded 50 bushels for 10 souls!`;
          tradeUsed = true;
        } else {
          message = `Trade failed—insufficient resources!`;
        }
      } else {
        message = `Trade already used!`;
      }
      addToLog(`<span class="text-brown-800">${message}</span>`);
      if (!message.includes('failed') && !message.includes('already')) {
        applyConsumptionAndArmy();
        applyRandomEvent();
        round++;
      }
      closeModal('trade-modal');
      checkGameOver();
    }

    function performUpgrade(type) {
      let message = '';
      let cost = type === 'granary' ? 50 : type === 'infirmary' ? 30 : 40;
      let popCost = type === 'granary' ? 5 : type === 'infirmary' ? 5 : 10;
      let paidWithWealth = village.food < cost;
      let useWealthOnly = village.wealth > 60;

      if (type === 'granary' && !village.upgrades.granary && ((village.food >= cost && (village.population >= popCost || useWealthOnly)) || (village.wealth >= cost && (village.population >= popCost || useWealthOnly)))) {
        if (paidWithWealth) village.wealth -= cost; else village.food -= cost;
        if (!useWealthOnly) village.population -= popCost;
        village.upgrades.granary = true;
        message = `Thy village builds a Granary!`;
      } else if (type === 'infirmary' && !village.upgrades.infirmary && ((village.food >= cost && (village.population >= popCost || useWealthOnly)) || (village.wealth >= cost && (village.population >= popCost || useWealthOnly)))) {
        if (paidWithWealth) village.wealth -= cost; else village.food -= cost;
        if (!useWealthOnly) village.population -= popCost;
        village.upgrades.infirmary = true;
        message = `Thy village builds an Infirmary!`;
      } else if (type === 'walls' && !village.upgrades.walls && ((village.food >= cost && (village.population >= popCost || useWealthOnly)) || (village.wealth >= cost && (village.population >= popCost || useWealthOnly)))) {
        if (paidWithWealth) village.wealth -= cost; else village.food -= cost;
        if (!useWealthOnly) village.population -= popCost;
        village.upgrades.walls = true;
        message = `Thy village raises Walls!`;
      } else {
        message = `Upgrade failed—insufficient resources or already built!`;
      }
      addToLog(`<span class="text-brown-800">${message}</span>`);
      if (!message.includes('failed')) {
        applyConsumptionAndArmy();
        applyRandomEvent();
        round++;
      }
      closeModal('upgrade-modal');
      checkGameOver();
    }

    function performAppease(faction) {
      let message = '';
      if (village.food >= 15) {
        village.food -= 15;
        village.morale[faction] = Math.min(100, village.morale[faction] + 20);
        message = `Appeased ${faction.charAt(0).toUpperCase() + faction.slice(1)}—Morale rises!`;
      } else {
        message = `Not enough Food to appease!`;
      }
      addToLog(`<span class="text-brown-800">${message}</span>`);
      if (!message.includes('failed')) {
        applyConsumptionAndArmy();
        applyRandomEvent();
        round++;
      }
      closeModal('appease-modal');
      checkGameOver();
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function showTutorial() {
      document.getElementById('tutorial-modal').style.display = 'block';
    }

    function showMilestones() {
      const list = document.getElementById('milestones-list');
      list.innerHTML = milestones.map(m => `<li>${m.name}: ${m.score} Legacy Score (${m.achieved ? 'Achieved' : 'Locked'})</li>`).join('');
      document.getElementById('milestones-modal').style.display = 'block';
    }

    function showEndings() {
      const list = document.getElementById('endings-list');
      list.innerHTML = endings.map(e => `<li>${e.name}: ${e.description} (${e.achieved ? 'Achieved' : 'Locked'})</li>`).join('');
      document.getElementById('endings-modal').style.display = 'block';
    }

    function calculateLegacyScore() {
      legacyScore = Math.floor((village.food + village.population * 2 + village.health * 3 + (village.morale.peasants + village.morale.clergy + village.morale.warriors)) * (difficulty === 'easy' ? 0.8 : difficulty === 'hard' ? 1.2 : 1));
      if (legacyScore > highScore) {
        highScore = legacyScore;
        localStorage.setItem('plagueHighScore', highScore);
      }
      milestones.forEach(m => {
        if (legacyScore >= m.score && !m.achieved) m.achieved = true;
      });
    }

    function addToLog(message) {
      eventLog.unshift(message);
      if (eventLog.length > 5) eventLog.pop();
      document.getElementById('event-log').innerHTML = eventLog.join('<br>');
    }

    function checkGameOver() {
      calculateLegacyScore();
      if (round >= maxRounds || village.population <= 0) {
        let message = '';
        if (mode === 'campaign') {
          const goalsMet = village.population > 80 && village.health > 70;
          if (goalsMet && gameState.campaignProgress.curseLifted) {
            gameState.campaignProgress.ending = 'True Victory';
            endings[0].achieved = true;
            message = `<p class="text-2xl text-green-600">Thy village thrives, curse lifted! Legacy Score: ${legacyScore} (High: ${highScore})</p>`;
          } else if (goalsMet && gameState.campaignProgress.rebel) {
            gameState.campaignProgress.ending = 'Rebel Triumph';
            endings[1].achieved = true;
            message = `<p class="text-2xl text-green-600">Thy rebels triumph, but curse lingers! Legacy Score: ${legacyScore} (High: ${highScore})</p>`;
          } else if (village.population > 0) {
            gameState.campaignProgress.ending = 'Cursed Survival';
            endings[2].achieved = true;
            message = `<p class="text-2xl text-yellow-600">Thy village survives, curse endures! Legacy Score: ${legacyScore} (High: ${highScore})</p>`;
          } else {
            gameState.campaignProgress.ending = 'Doomed Village';
            endings[3].achieved = true;
            message = `<p class="text-2xl text-red-600">Thy village falls! Legacy Score: ${legacyScore} (High: ${highScore})</p>`;
          }
          localStorage.setItem('plagueEndings', JSON.stringify(endings));
        } else {
          message = village.population > 0
            ? `<p class="text-2xl text-green-600">Thy village clings to life! Legacy Score: ${legacyScore} (High: ${highScore})</p>`
            : `<p class="text-2xl text-red-600">Thy village is no more! Legacy Score: ${legacyScore} (High: ${highScore})</p>`;
        }
        document.getElementById('game-status').innerHTML = message;
        document.getElementById('actions').innerHTML = `
          <div class="flex justify-center mt-4">
            <button onclick="resetGame()" class="button bg-blue-600 text-white p-3 rounded-lg font-semibold">Restart Game</button>
          </div>
        `;
        document.getElementById('warnings').innerHTML = '';
        document.getElementById('round-progress').style.width = '100%';
      } else {
        updateSeason();
        startTurn();
      }
    }

    function updateUI() {
      const criticalThresholds = {
        population: difficulty === 'easy' ? 20 : difficulty === 'hard' ? 10 : 15,
        food: difficulty === 'easy' ? 50 : difficulty === 'hard' ? 20 : 30,
        health: difficulty === 'easy' ? 60 : 50,
        morale: 30
      };
      const popClass = village.population < criticalThresholds.population ? 'critical' : '';
      const foodClass = village.food < criticalThresholds.food ? 'critical' : '';
      const healthClass = village.health < criticalThresholds.health ? 'critical' : '';
      const peasantClass = village.morale.peasants < criticalThresholds.morale ? 'critical' : '';
      const clergyClass = village.morale.clergy < criticalThresholds.morale ? 'critical' : '';
      const warriorClass = village.morale.warriors < criticalThresholds.morale ? 'critical' : '';
      const upgrades = Object.keys(village.upgrades).filter(u => village.upgrades[u]).map(u => u.charAt(0).toUpperCase() + u.slice(1)).join(', ') || 'None';
      const relics = Object.keys(village.relics).filter(r => village.relics[r]).map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ') || 'None';
      const arc = gameState.campaignProgress.loyal ? 'Loyalist' : gameState.campaignProgress.rebel ? 'Rebel' : gameState.campaignProgress.mystic ? 'Mystic' : 'None';
      document.getElementById('village').innerHTML = `
        <h2 class="text-2xl font-bold">${village.name}</h2>
        <p><span class="font-semibold">Population:</span> <span class="${popClass}">${Math.floor(village.population)}</span></p>
        <p><span class="font-semibold">Food:</span> <span class="${foodClass}">${Math.floor(village.food)} bushels</span></p>
        <p><span class="font-semibold">Health:</span> <span class="${healthClass}">${Math.floor(village.health)}</span></p>
        <p><span class="font-semibold">Wealth:</span> ${Math.floor(village.wealth)} gold</p>
        <p><span class="font-semibold">Peasants’ Morale:</span> <span class="${peasantClass}">${village.morale.peasants}</span></p>
        <p><span class="font-semibold">Clergy’s Morale:</span> <span class="${clergyClass}">${village.morale.clergy}</span></p>
        <p><span class="font-semibold">Warriors’ Morale:</span> <span class="${warriorClass}">${village.morale.warriors}</span></p>
        <p><span class="font-semibold">Upgrades:</span> ${upgrades}</p>
        <p><span class="font-semibold">Relics:</span> ${relics}</p>
        <p><span class="font-semibold">Legacy Score:</span> ${Math.floor(village.food + village.population * 2 + village.health * 3 + (village.morale.peasants + village.morale.clergy + village.morale.warriors))}</p>
        ${mode === 'campaign' ? `<p><span class="font-semibold">Goals:</span> Population > ${80} (${Math.floor(village.population)}/80), Health > ${70} (${Math.floor(village.health)}/70)</p><p><span class="font-semibold">Path:</span> ${arc}</p>` : ''}
      `;
      document.getElementById('game-status').innerHTML = `<p class="text-xl">Year ${round} of ${maxRounds} (${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}, ${season.charAt(0).toUpperCase() + season.slice(1)})</p>`;
      document.getElementById('round-progress').style.width = `${Math.floor((round / maxRounds) * 100)}%`;

      const warnings = [];
      const consumptionRate = (difficulty === 'easy' ? 1.0 : difficulty === 'hard' ? 1.6 : 1.3) * (season === 'summer' ? 1.1 : 1) * (village.relics.plenty ? 1.1 : 1);
      const foodNeeded = village.population * consumptionRate;
      if (village.food < foodNeeded) {
        warnings.push(difficulty === 'easy' ? `Famine looms—need ${Math.floor(foodNeeded - village.food)} more Food!` : `Famine threatens—need ${Math.floor(foodNeeded - village.food)} more Food!`);
      }
      if (village.health < criticalThresholds.health) {
        warnings.push(difficulty === 'hard' ? `Pestilence stalks—tend the sick now!` : `Sickness spreads—tend the sick!`);
      }
      if (village.population < criticalThresholds.population) {
        warnings.push(`Village dwindles—call newcomers!`);
      }
      if ([6, 9].includes(round + 1)) {
        warnings.push(difficulty === 'hard' ? `King’s army nears—stockpile Food!` : `Royal tribute looms—prepare Food!`);
      }
      if (village.health > 80 && village.food >= 30) {
        warnings.push(`Health abounds—hold a festival!`);
      }
      if (season === 'winter' && village.food >= 20) {
        warnings.push(`Winter strengthens defenses—fortify now!`);
      }
      if (!village.upgrades.granary && (village.food >= 50 || village.wealth >= 50) && (village.population >= 5 || village.wealth > 60)) {
        warnings.push(difficulty === 'easy' ? `Build a Granary for richer harvests!` : `A Granary bolsters thy stores!`);
      }
      if (village.morale.peasants < criticalThresholds.morale) {
        warnings.push(`Peasants revolt—appease them now!`);
      }
      if (village.morale.clergy < criticalThresholds.morale) {
        warnings.push(`Clergy falters—appease them now!`);
      }
      if (village.morale.warriors < criticalThresholds.morale) {
        warnings.push(`Warriors mutiny—appease them now!`);
      }
      if (gameState.eventChains.relicCurse.active) {
        warnings.push(`Relic’s curse festers—purify it!`);
      }
      if (gameState.eventChains.banditSaga.active) {
        warnings.push(`Bandits threaten—prepare defenses!`);
      }
      if (village.wealth < 40 && [6, 9].includes(round + 1)) {
        warnings.push(`Royal summons nears—gather Wealth!`);
      }
      if (village.population < 10 || village.food < 10) {
        warnings.push(`<span class="peril">Village in Peril—act swiftly!</span>`);
      }
      if (mode === 'campaign') {
        warnings.push(`Campaign Goals: Population ${Math.floor(village.population)}/80, Health ${Math.floor(village.health)}/70`);
      }
      if (round === 9) {
        warnings.push(`Final year approaches—${mode === 'campaign' ? 'meet goals!' : 'maximize Legacy!'}`);
      }
      document.getElementById('warnings').innerHTML = warnings.length
        ? `<p class="warning">${warnings.join(' ')}</p>`
        : '';
    }

    function startTurn() {
	  updateUI();
	  if (village.population <= 0) {
		checkGameOver();
		return;
	  }
	  const actionMultiplier = (difficulty === 'easy' ? 1.2 : difficulty === 'hard' ? 0.8 : 1);
	  document.getElementById('actions').innerHTML = `
		<div class="flex justify-center gap-4 flex-wrap">
		  <div class="tooltip">
			<button onclick="performAction('farm')" class="button bg-green-600 text-white p-3 rounded-lg font-semibold">Till the Fields</button>
			<span class="tooltiptext">Gain ~${Math.floor(40 * actionMultiplier * (season === 'spring' ? 1.2 : 1))} Food${season === 'autumn' ? ", chance of Bumper Crop" : ""}</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('farm', true)" class="button bg-green-800 text-white p-3 rounded-lg font-semibold" ${village.wealth < 5 ? 'disabled' : ''}>Double Down Farm</button>
			<span class="tooltiptext">Spend 5 Wealth for ~${Math.floor(80 * actionMultiplier * (season === 'spring' ? 1.2 : 1))} Food, 10% fail risk</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('heal')" class="button bg-blue-600 text-white p-3 rounded-lg font-semibold">Tend the Sick</button>
			<span class="tooltiptext">Gain ~${Math.floor(15 * actionMultiplier * (season === 'winter' ? 1.2 : 1))} Health${season === 'winter' ? ", boosted by Clergy" : ""}</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('heal', true)" class="button bg-blue-800 text-white p-3 rounded-lg font-semibold" ${village.wealth < 5 ? 'disabled' : ''}>Double Down Heal</button>
			<span class="tooltiptext">Spend 5 Wealth for ~${Math.floor(30 * actionMultiplier * (season === 'winter' ? 1.2 : 1))} Health, 10% fail risk</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('recruit')" class="button bg-purple-600 text-white p-3 rounded-lg font-semibold">Call Newcomers</button>
			<span class="tooltiptext">Gain ~${Math.floor(12 * actionMultiplier * (season === 'spring' ? 0.8 : 1))} Population${season === 'summer' ? ", boosted by Peasants" : ""}</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('recruit', true)" class="button bg-purple-800 text-white p-3 rounded-lg font-semibold" ${village.wealth < 5 ? 'disabled' : ''}>Double Down Recruit</button>
			<span class="tooltiptext">Spend 5 Wealth for ~${Math.floor(24 * actionMultiplier * (season === 'spring' ? 0.8 : 1))} Population, 10% fail risk</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('fortify')" class="button bg-gray-600 text-white p-3 rounded-lg font-semibold">Fortify Village</button>
			<span class="tooltiptext">Spend ${Math.floor(20 * (season === 'winter' ? 0.8 : season === 'spring' ? 1.1 : 1))} Food to halve damage${village.upgrades.walls ? " for 2 turns" : ""}</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('trade')" class="button bg-yellow-600 text-white p-3 rounded-lg font-semibold" ${tradeUsed ? 'disabled' : ''}>Trade</button>
			<span class="tooltiptext">Swap 10 Population for 50 Food or vice versa (once)</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('festival')" class="button bg-pink-600 text-white p-3 rounded-lg font-semibold" ${village.health <= 80 || village.food < 30 ? 'disabled' : ''}>Hold Festival</button>
			<span class="tooltiptext">Spend 30 Food for ~${Math.floor(15 * actionMultiplier)} Population if Health > 80</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('upgrade')" class="button bg-orange-600 text-white p-3 rounded-lg font-semibold">Upgrade Village</button>
			<span class="tooltiptext">Build Granary, Infirmary, or Walls (costs Food/Wealth and Population)</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('tax')" class="button bg-amber-600 text-white p-3 rounded-lg font-semibold">Tax Villagers</button>
			<span class="tooltiptext">Gain ~${Math.floor(15 * actionMultiplier)} Wealth, angers Peasants</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('appease')" class="button bg-teal-600 text-white p-3 rounded-lg font-semibold">Appease Faction</button>
			<span class="tooltiptext">Spend 15 Food to boost a faction’s Morale by 20</span>
		  </div>
		  <div class="tooltip">
			<button onclick="performAction('mercenaries')" class="button bg-red-600 text-white p-3 rounded-lg font-semibold" ${village.wealth < 30 ? 'disabled' : ''}>Hire Mercenaries</button>
			<span class="tooltiptext">Spend 30 Wealth for 15 Population</span>
		  </div>
		  <div class="preview-tooltip">
			<button class="button bg-indigo-600 text-white p-3 rounded-lg font-semibold">Next Turn Preview</button>
			<span class="preview-text">${getTurnPreview()}</span>
		  </div>
		</div>
	  `;
	}

	// Bind event listeners for start screen buttons
	document.getElementById('begin-btn').addEventListener('click', startGame);
	document.getElementById('tutorial-btn').addEventListener('click', showTutorial);
	document.getElementById('milestones-btn').addEventListener('click', showMilestones);
	document.getElementById('endings-btn').addEventListener('click', showEndings);
  </script>
</body>
</html>
